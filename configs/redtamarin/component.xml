<?xml version="1.0" encoding="UTF-8"?>

<project name="redtamarin-component" default="main" basedir=".">

    <target name="clean">
        <delete dir="bin-component"/>
    </target>

    <target name="before" depends="define-constants,define-tasks">
        <mkdir dir="bin-component"/>
    </target>

    <target name="define-constants">

        <property name="FLEX_HOME_MAC" value="/OpenSource/Flex/sdks/3.4.0" />
        <property name="FLEX_HOME_WIN" value="c:/OpenSource/Flex/sdks/3.4.0" />

        <condition property="FLEX_HOME" value="${FLEX_HOME_MAC}">
            <os family="mac" />
        </condition>
        
        <condition property="FLEX_HOME" value="${FLEX_HOME_WIN}">
            <os family="windows" />
        </condition>

        <tstamp>
            <format property="TODAY" pattern="dd MMMM yyyy" />
        </tstamp>

        <property file="build/build.properties"/>
        <property file="build/version.properties" prefix="projects.redtamarin." />

        <exec executable="svnversion" outputproperty="subversion_revision"> 
            <arg line="-n ${basedir}"/> 
        </exec> 
        <script language="javascript"> 
        var revision  = String( project.getProperty("subversion_revision") );
        if( revision.charAt(revision.length-1) == "M" )
        {
            revision = revision.substr(0, revision.length-1)
        }
        if( revision.indexOf(":") > -1 )
        {
            revision = revision.split(":")[0];
        }
        project.setNewProperty("svn.info.rev", revision);
        </script>
        <property name="projects.redtamarin.version.revision" value="${svn.info.rev}"/>
        <property name="projects.redtamarin.version" value="${projects.redtamarin.version.major}.${projects.redtamarin.version.minor}.${projects.redtamarin.version.build}.${projects.redtamarin.version.revision}" />
        <echo message="Building redtamarin component v${projects.redtamarin.version}"/>
    
    </target>

    <target name="define-tasks">
        
        <!-- Define additional ant tasks -->
        <taskdef resource="net/sf/antcontrib/antlib.xml">
            <classpath >
                <fileset dir="build/ant/" includes="ant-contrib-1.0b3.jar"/>
            </classpath>
        </taskdef>
        <echo message="ant-contrib tasks defined" />

        <taskdef resource="flexTasks.tasks" classpath="${FLEX_HOME}/ant/lib/flexTasks.jar" />
        <echo message="Flex tasks defined" />
        
    </target>

    <target name="main" depends="clean,before,build,after">
    </target>

    <target name="after">
        <copy file="license.txt" todir="bin-component"/>
        <copy file="changelog.txt" todir="bin-component"/>
        <copy file="readme.txt" todir="bin-component"/>

        <property name="RELEASE_ZIP" value="${RELEASE_NAME}_${projects.redtamarin.version}_SWC.zip"/>

        <zip basedir="bin-component" destfile="bin-component/${RELEASE_ZIP}" />
    </target>

    <target name="build" depends="build-builtin-swc,build-clib-swc,build-redtamarin-swc">
    </target>

    <target name="build-builtin-swc">
        <compc
            output="bin-component/builtin.swc"
            target-player="9.0"
        >
            <load-config>build/flex-config.xml</load-config>
            <define name="CONFIG::BYTEARRAY_API_FLASH"  value="true" />
            <define name="CONFIG::BYTEARRAY_API_AIR" value="false" />
            <strict>false</strict>
            <optimize>true</optimize>
            <warnings>false</warnings>
            <verbose-stacktraces>true</verbose-stacktraces>
            <compute-digest>false</compute-digest>
            
            <include-sources dir="src/tamarin/core"
             includes="builtin.as, Math.as, Error.as, Date.as, RegExp.as, XML.as, IDataInput.as, IDataOutput.as, ByteArray.as" />
            
            <metadata date="${TODAY}" title="builtin">
                <publisher name="${project.publisher}" />
                <creator name="${project.creator}" />
            </metadata>
        </compc>
    </target>

    <target name="build-clib-swc">
        <compc
            output="bin-component/clib.swc"
            target-player="9.0"
        >
            <load-config>build/flex-config.xml</load-config>
            <define name="CONFIG::BYTEARRAY_API_FLASH"  value="true" />
            <define name="CONFIG::BYTEARRAY_API_AIR" value="false" />
            <strict>false</strict>
            <optimize>true</optimize>
            <warnings>false</warnings>
            <verbose-stacktraces>true</verbose-stacktraces>
            <compute-digest>false</compute-digest>

            <external-library-path dir="bin-component">
               <include name="builtin.swc"/>
            </external-library-path>
            
            <include-sources dir="src/tamarin/as3/clib/C"
             includes="errno.as, socket.as, stdio.as, stdlib.as, string.as, unistd.as" />
            
            <metadata date="${TODAY}" title="clib">
                <publisher name="${project.publisher}" />
                <creator name="${project.creator}" />
            </metadata>
        </compc>
    </target>

    <target name="build-redtamarin-swc">
        <compc
            output="bin-component/redtamarin.swc"
            target-player="9.0"
        >
            <load-config>build/flex-config.xml</load-config>
            <define name="CONFIG::BYTEARRAY_API_FLASH"  value="true" />
            <define name="CONFIG::BYTEARRAY_API_AIR" value="false" />
            <strict>false</strict>
            <optimize>true</optimize>
            <warnings>false</warnings>
            <verbose-stacktraces>true</verbose-stacktraces>
            <compute-digest>false</compute-digest>

            <library-path dir="bin-component">
               <include name="builtin.swc"/>
               <include name="clib.swc"/>
            </library-path>

            <include-sources dir="src/tamarin/shell"
             includes="shell_toplevel.as, Domain.as, Endian.as, Java.as" />

            <include-sources dir="src/tamarin/extensions"
             includes="Dictionary.as, Sampler.as, Trace.as" />

            <include-sources dir="src/tamarin/as3/shell/avmplus/profiles"
             includes="Profile.as, TamarinProfile.as, RedTamarinProfile.as, FlashPlayerProfile.as, AIRProfile.as, DesktopProfile.as, ExtendedDesktopProfile.as, MobileDeviceProfile.as, TVProfile.as, ExtendedTVProfile.as" />
            
            <include-sources dir="src/tamarin/as3/shell/avmplus"
             includes="System.as, OperatingSystem.as, FileSystem.as, Socket.as" />

            <include-sources dir="src/tamarin/as3/avmglue/flash/utils"
             includes="flash_proxy.as, IExternalizable.as, CompressionAlgorithm.as, describeType.as, getDefinitionByName.as, getQualifiedClassName.as, getQualifiedSuperclassName.as, getTimer.as" />
            
            <metadata date="${TODAY}" title="redtamarin">
                <publisher name="${project.publisher}" />
                <creator name="${project.creator}" />
            </metadata>
        </compc>
    </target>


</project>

